<!DOCTYPE html>
<html lang="en">
    <head>
        
        <meta charset="UTF-8">
        <title>Study: Memory festival</title>
        <script src="jspsych-6.1.0/jspsych.js"></script>
        <script src="jspsych-psychophysics-1.3/jspsych-psychophysics.js">
        //I got this from http://jspsychophysics.hes.kyushu-u.ac.jp/
        //should be cited: de Leeuw, J.R. jsPsych: A JavaScript library for creating behavioral experiments in a Web browser. Behav Res 47, 1â€“12 (2015). https://doi.org/10.3758/s13428-014-0458-y
        // and the kuroki paper (its findable at the link and also in my zotero)          
        </script>
        <script src="jspsych-6.1.0/plugins/jspsych-html-keyboard-response.js"></script>
        <script src="jspsych-6.1.0/plugins/jspsych-image-button-response.js"></script>
        <script src="jspsych-6.1.0/plugins/jspsych-html-button-response.js"></script>
        <script src="jspsych-6.1.0/plugins/jspsych-image-keyboard-response.js"></script>
        <script src="jspsych-6.1.0/plugins/jspsych-survey-text.js"></script>
        <script src="jspsych-6.1.0/plugins/jspsych-instructions.js"></script>
        <script src="typed-response.js"></script>
        <link href="jspsych-6.1.0/css/jspsych.css" rel="stylesheet" type="text/css"></link>  

        <!-- packeges needed to interact with php -->
        <script type="text/javascript" src="./js/jquery-1.11.3.js"></script>
        <script type="text/javascript" src="./js/jquery-ui-1.12.1.min.js"></script>
        
    </head>


    <style>
        body {
                background-color:white ;
                color: black;
        }
        
    </style>
    <body> 
    </body>
    

    <script>

        // disable backspace button as a way to navigate
        if (typeof window.event != 'undefined')
            document.onkeydown = function()
            {
                if (event.srcElement.tagName.toUpperCase() != 'INPUT')
                    return (event.keyCode != 8);
            }
        else
            document.onkeypress = function(e)
            {
                if (e.target.nodeName.toUpperCase() != 'INPUT')
                    return (e.keyCode != 8);
            }




        var assignmentID = turkGetParam('assignmentId');
        var workerID = turkGetParam('workerId');

        if (assignmentID == ""){
            assignmentID = "test"
        }

        if (workerID == ""){
            workerID = "randomPerson"
        }



        // generate a random subject ID with 15 characters
        var subject_id = jsPsych.randomization.randomID(15);

        //construct next page link with worker id and assignment id in the URI
        var nextPage = "end_instructions.html?" + "workerId=" + workerID + "&assignmentId=" + assignmentID + "&subject_id=" + subject_id; 

        // measure the time at the start of the experiment 
        // The getTime() method returns the number of milliseconds between midnight of January 1, 1970 and the specified date.
        var date = new Date()
        var startTime = date.getTime()

        var dateString = date.getDate().toString()+"_"+date.getMonth().toString()+"_"+date.getFullYear().toString()+"_"+date.getHours().toString()+"_"+date.getMinutes().toString()+"_"+date.getSeconds().toString()

        


        // -------      all the FUNCTIONS that javascript doesnt have so I have to write them myself #Imisspython      -------\\
 
        // function to generate random number from 0 to max-1
        function getRandomInt(max) {
            return Math.floor(Math.random() * Math.floor(max));
        }

        //this function generates a random list of integers between zero and max-1 without repetitions of length length
        function getRandomIndexes(length, max=9) {
            var indexes = []
            if (length > max){
                return "the length is bigger than the max number, which makes this function quite impossible"
            }
            while (indexes.length < length){
                a = getRandomInt(max)
                if (indexes.includes(a)){}
                else{
                    indexes.push(a)
                }

            }
            return indexes
        }

        function getSample(letterList, n) {
            return jsPsych.randomization.sampleWithoutReplacement(letterList, n);
        }


        // this function takes a list as input and returns a list of length length which is a shuffeled sublist of the original list (there is also the option of specifying a max index)
        function getShuffeledSublist(list, length, max=list.length){

            //check if the input is ok and if not return feedback
            if (length > list.length){
                return "the length is bigger than the list, which makes this function quite impossible"
            }else if (max > list.length){
                return "the max is bigger than the list, which makes this function quite impossible"
            }else if (length > max){
                return "the length is bigger than the max number, which makes this function quite impossible"
            }  

            //create a shuffeled sublist
            var shuffeledSublist = []
            var indexes = getRandomIndexes(length, max)
            for (i = 0; i < length; i++) {
                shuffeledSublist.push(list[indexes[i]]);
            }
            return shuffeledSublist
        }

        // this function allows me to create copies of lists and objects, so that modefying the copy does not change the original (copied this of the internet: https://stackoverflow.com/questions/728360/how-do-i-correctly-clone-a-javascript-object)
        function clone(obj) {
            var copy;

            // Handle the 3 simple types, and null or undefined
            if (null == obj || "object" != typeof obj) return obj;

            // Handle Date
            if (obj instanceof Date) {
                copy = new Date();
                copy.setTime(obj.getTime());
                return copy;
            }

            // Handle Array
            if (obj instanceof Array) {
                copy = [];
                for (var i = 0, len = obj.length; i < len; i++) {
                    copy[i] = clone(obj[i]);
                }
                return copy;
            }

            // Handle Object
            if (obj instanceof Object) {
                copy = {};
                for (var attr in obj) {
                    if (obj.hasOwnProperty(attr)) copy[attr] = clone(obj[attr]);
                }
                return copy;
            }

            throw new Error("Unable to copy obj! Its type isn't supported.");
        }


        // function to shuffel arrays
        function shuffel(a) {
            var j, x, i;
            for (i = a.length - 1; i > 0; i--) {
                j = Math.floor(Math.random() * (i + 1));
                x = a[i];
                a[i] = a[j];
                a[j] = x;
            }
            return a;
        }

        //this function shuffels the generated sequences according to the shuffel order arrays
        function getShufffeledSequence(sequence, shuffelList){
            shuffeledSequence =[]
            for (let i in shuffelList){ 
                shuffeledSequence.push(sequence[shuffelList[i]])
            }
            return shuffeledSequence
        };

        function turkGetParam(name) {
            var regexS = "[\?&]" + name + "=([^&#]*)";
            var regex = new RegExp(regexS);
            var tmpURL = document.location.href;
            var results = regex.exec(tmpURL);
            if (results == null) {
                return "";
            } else {
                return results[1];
            }
        }


        // -------                all my lovely VARIABLES                -------\\

        
     
        var x = window.innerWidth / 2;  // x center of the screen
        var x_scale = 90   // variable to adjust the positioning
        var y = window.innerHeight / 2;  // y center of the screen
        var x_width = 50

        // height setting for the bars
        var base_height = 150
        var scale_height = 30
        var query_size = 100 // radius of the query

        // variables for reward
        var earned = 8
        var base_reward = 3

        var repetitions = 1 // reduced number of repetitions for the practive blocks

        var breakBetweenBlocks = 60000 // this should be 1 minute


        // settings for the canvas: 
        var canvas_h = base_height+scale_height+30//window.innerHeight-200
        var canvas_w = x_scale+3*x_width//window.innerWidth-200
        var canvas_x_center = canvas_w/2


        // stimulus height for the feedback stimulus 
        var fbHeight = 300

        // presentation time for the word list 
        var presentationTime = 4000

        // presentation time for the letters
        var presentationTime_dist = 1000

        // response time for typing
        var responseTime = 5000

        var responseTime_dist =  10000

        // number of distractor trials
        var NDistracorTrials = 10
        var letterLengths = [3, 3, 4, 4, 5, 5, 6, 6, 7, 7]

        // possible letters to be recalled for the distractor task
        var letters = ['f', 'h', 'j', 'k', 'l', 'n', 'p', 'q', 'r', 's', 't', 'y']; //
        

        // and lets set up the timeline 
        var timeline = []

        // ----------                                 set up to be learned lists                                   ----------\\

        var PairsMaxSim02 = ['bear grass',
                            'domino statue',
                            'fudge rifle',
                            'medal torso',
                            'blower faucet',
                            'game pepper',
                            'globe coal',
                            'cloak chalk',
                            'clay tick',
                            'hanger lime',
                            'suit sheet',
                            'radio dress',
                            'leash drink',
                            'lion fossil',
                            //'easel icicle',
                            'sponge watch',
                            'blimp taco',
                            'cannon garlic',
                            //'coop boot',
                            'bikini bison',
                            'ankle dagger',
                            'chest dial',
                            'beard puck',
                            'bedpan cherry',
                            'binder weed',
                            'cocoon yogurt',
                            'crepe lens',
                            'record kite',
                            'badger acorn',
                            //'throne spout',
                        ];

        var PairsMaxSim04 = ['rope skunk',
                            'closet camper',
                            'earwig walnut',
                            'shelf gauze',
                            'slime possum',
                            'poppy crayon',
                            'ramp noose',
                            'kayak block',
                            'raft shorts',
                            //'moss velcro',
                            'daisy riser',
                            'barrel crane',
                            //'mulch beetle',
                            'blind switch',
                            'leek roll',
                            'pipe paper',
                            'bowtie wolf',
                            'cape chime',
                            'target clasp',
                            'crutch camel',
                            'cactus moose',
                            'money wand',
                            'coat boar',
                            'prism ring',
                            'root squash',
                            'tank bumper',
                            //'taffy kitten',
                            'bonnet scoop',
                            'walrus arrow',
                            'eraser mirror'];

        var PairsMaxSim06 = ['tomato dough',
                            'cookie cereal',
                            //'veil trowel',
                            //'kazoo cymbal',
                            //'punch anvil',
                            'desk toilet',
                            'branch train',
                            'cart buggy',
                            'cigar flask',
                            'rosary altar',
                            'heater tripod',
                            'napkin tinsel',
                            'fungus moth',
                            'radish melon',
                            'powder floss',
                            'chisel spool',
                            'mast frame',
                            'tape wire',
                            //'gyro bolt',
                            'seed leaf',
                            'makeup paint',
                            //'sloth gourd',
                            'stem stump',
                            'chip tablet',
                            'bonsai tulip',
                            'coyote cobra',
                            'slicer hummus',
                            'anklet thumb',
                            'stove teepee',
                            'yacht ship'];

        var PairsMaxSim08 = ['sauce fondue',
                            'knee wrist',
                            //'sequin kimono',
                            'chick girl',
                            'kiwi apple',
                            'flag banner',
                            'file folder',
                            'squid fish',
                            'goose duck',
                            'horse pony',
                            'kilt tiara',
                            'candle lamp',
                            'sundae sushi',
                            'yarn alpaca',
                            'juice soda',
                            'jersey shirt',
                            'snake koala',
                            'hotdog bacon',
                            'chili clove',
                            'chin neck',
                            'puddle sand',
                            'knife sheath',
                            'drain sink',
                            'mouth nose',
                            'vial goblet',
                            'parrot turtle',
                            'chips potato',
                            'filter vacuum',
                            'ruby jewel',
                            'racket hinge'];

        var PairsMaxSim1 = [//'tackle tack',
                            'spoon saucer',
                            'tongs skewer',
                            //'grill grille',
                            'cake scone',
                            'knob button',
                            'tiger panda',
                            //'valve gasket',
                            'orange amber',
                            'muffin crumb',
                            'flower orchid',
                            'sandal insole',
                            'pasta quiche',
                            'berry pear',
                            'bird crow',
                            'cello violin',
                            //'donkey monkey',
                            'prune thorn',
                            'otter iguana',
                            //'locket lock',
                            'jacket blazer',
                            'gravy grits',
                            'crank pulley',
                            'eagle hawk',
                            'teabag coffee',
                            'leech worm',
                            'blouse skirt',
                            'buckle zipper',
                            'helmet visor',
                            'shovel bucket'];

        // created from rejects from the other lists
        var PairsRandom = ['grill monkey',     
                            'locket kimono',
                            'bolt towel',
                            'kitten beetle',
                            'moss boot',
                            'throne donkey'
                            ];
        

        // ------------------------- Set up the lists and the order in which the list are presented ----------------------------\\

        // set up the list length that will be presented
        var ListLengths = [2, 12, 22, 32];
        //var ListLengths = [4, 14, 24, 26];
       // var ListLengths = [6, 16, 18, 28];
       // var ListLengths = [8, 20, 20, 30];
       
        

        // determine the random word pairs which will be part of each list
        var shuffeledPairsMaxSim1 = shuffel(clone(PairsMaxSim1));
        var shuffeledPairsMaxSim08 = shuffel(clone(PairsMaxSim08));
        var shuffeledPairsMaxSim06 = shuffel(clone(PairsMaxSim06));
        var shuffeledPairsMaxSim04 = shuffel(clone(PairsMaxSim04));
        var shuffeledPairsMaxSim02 = shuffel(clone(PairsMaxSim02));

        // Numer of list devisions based on similarity (should be a devider of the list length)
        var NumberOfSimLists = 5


        // determine the order in which the word pair lists are presented
        var ListLengthsOrder = shuffel(ListLengths);

        // set up an arraay in which to save the word pair lists
        var WordPairLists = [];
        
        // all positions here are coded from the back
        // define the positions which are always queried
        var AlwaysQueriedPositions = [2, 4, 5, 7, 9]; // the positions are coded from the back

        // make the lists
        var startWordPosition = 0;
        for (var i = 0; i < ListLengths.length; i++){

            //get the wordpairs that will be queried
            var quriedsublist = [];

            quriedsublist.push(shuffeledPairsMaxSim1.slice(startWordPosition, startWordPosition + 1));
            quriedsublist.push(shuffeledPairsMaxSim08.slice(startWordPosition, startWordPosition + 1));
            quriedsublist.push(shuffeledPairsMaxSim06.slice(startWordPosition, startWordPosition + 1));
            quriedsublist.push(shuffeledPairsMaxSim04.slice(startWordPosition, startWordPosition + 1));
            quriedsublist.push(shuffeledPairsMaxSim02.slice(startWordPosition, startWordPosition + 1));
            var startWordPosition = startWordPosition + 1

            // flatten the sublist
            var quriedsublist = quriedsublist.flat()
            // and shuffel it
            var quriedsublist = shuffel(quriedsublist)

            
            // if the List Length is 10 or larger we can have the queries from controlled positions
            if (ListLengthsOrder[i] > 9){
                var numberofWordPairs = Math.ceil(ListLengthsOrder[i]/NumberOfSimLists);

                var sublist = [];
                sublist.push(shuffeledPairsMaxSim1.slice(startWordPosition, startWordPosition + numberofWordPairs - 1));
                sublist.push(shuffeledPairsMaxSim08.slice(startWordPosition, startWordPosition + numberofWordPairs - 1));
                sublist.push(shuffeledPairsMaxSim06.slice(startWordPosition, startWordPosition + numberofWordPairs - 1));
                sublist.push(shuffeledPairsMaxSim04.slice(startWordPosition, startWordPosition + numberofWordPairs - 1));
                sublist.push(shuffeledPairsMaxSim02.slice(startWordPosition, startWordPosition + numberofWordPairs - 1));
                var startWordPosition = startWordPosition + numberofWordPairs - 1;

                // flatten the sublist
                var sublist = sublist.flat()
                // and shuffel it
                var sublist = shuffel(sublist)

                var QueriedPos = []
                for (var k = 0; k < AlwaysQueriedPositions.length; k++){
                    index = ListLengths[i] - AlwaysQueriedPositions[k]
                    QueriedPos.push(index)
                };

                var finalsublist = [];

                var sublistItem = 0
                var queriedSublistItem = 0


                // at the queried items to the list
                for (var k = 0; k < ListLengths[i]; k++){
                    if (QueriedPos.includes(k)){
                        finalsublist.push(quriedsublist[queriedSublistItem])
                        queriedSublistItem = queriedSublistItem + 1
                    }else{
                        
                        finalsublist.push(sublist[sublistItem])
                        sublistItem = sublistItem + 1
                    }
                };

                
            }
            // otherwiese we want to still tyr to vary the similarity, but we have to do so more randomly
            else{
                //get the wordpairs that will be queried

                // first for list length that are 5 or less
                if (quriedsublist.length >= ListLengthsOrder[i]){

                    var finalsublist = clone(quriedsublist).slice(0, ListLengthsOrder[i])
                }

                // and for lists that are more then 5
                else{

                    var finalsublist = [];
                    finalsublist.push(quriedsublist.flat())
                    var NcurrentWordPairs = finalsublist.length;
                    var shuffeledPairsRandom = shuffel(clone(PairsRandom));
                    var sublistItem = 0
                    // fill the list up with random words
                    while (NcurrentWordPairs < ListLengthsOrder[i]){

                        finalsublist.push(shuffeledPairsRandom[sublistItem])
                        var shuffeledPairsRandom = shuffeledPairsRandom + 1
                        sublistItem = sublistItem + 1
                        NcurrentWordPairs = NcurrentWordPairs +1 

                    }
                    // shuffel the final sublist
                    var finalsublist = shuffel(clone(finalsublist)).flat();
                }
            }


            WordPairLists.push(finalsublist)
            

         };

        // ------------------------- make the list of the cue and target words ----------------------------\\

        // all positions here are coded from the back
        // define the positions which are always queried
        var AlwaysQueriedPositions = [2, 4, 5, 7, 9]; // the positions are coded from the back

        var NQueriedPositions = 10;

        // lets get some random positions for the other 5 queries from each list
        var AllQueriedPositions = [];

        for (var i = 0; i < ListLengths.length; i++){
            
            if (ListLengthsOrder[i] > 9){
                var quriedPositions = clone(AlwaysQueriedPositions)
                while (quriedPositions.length < NQueriedPositions) {
                    var randomindex = getRandomInt(ListLengthsOrder[i])+1
                    var present = quriedPositions.includes(randomindex)
                    if (present == false){
                        quriedPositions.push(randomindex)
                    }
                }
                var quriedPositions = shuffel(quriedPositions)
            } 
            // if the listength is 10 or lower all positions get queried
            else {

                var quriedPositions = shuffel([...Array(ListLengthsOrder[i])].map((_, index) => index + 1))
            }
            AllQueriedPositions.push(quriedPositions)
            
        };

        // Now lets make the lists with the actual cues and targets

        var AllCues = []
        var AllTargets = []

        for (var i = 0; i < AllQueriedPositions.length; i++){
            var Cues = []
            var Targets = []
            for (var j = 0; j < AllQueriedPositions[i].length; j++){
                var queriedPos = -AllQueriedPositions[i][j]
                var QueriedWordPair = WordPairLists[i].at(queriedPos)
                // randomise which word is the target and which is the cue
                var cuetarget = shuffel([0,1])
                var QueriedWordPair =  QueriedWordPair.split(" ")
                Cues.push(QueriedWordPair[cuetarget[0]])
                Targets.push(QueriedWordPair[cuetarget[1]])
            }
            AllCues.push(Cues)
            AllTargets.push(Targets)
        };


        // make the list of letters to be presented in the distractor task

        var AllLetterSequences = []
        var AllLetterLengthOrder = []


        for (let i in ListLengthsOrder){

            var letterLengthOrder = shuffel(clone(letterLengths))
            AllLetterLengthOrder.push(letterLengthOrder)
            var LetterSequences = []

            for (n = 0; n < NDistracorTrials; n++){

                correctSEQ = getSample(letters, letterLengthOrder[n])
                LetterSequences.push(correctSEQ)
        
            };
            AllLetterSequences.push(LetterSequences)
        };




    

        // ------------------------- make some egeneric trials for futher usage ----------------------------\\

        

        var cross = {
            obj_type: 'cross',
            startX: canvas_w/2, // location in the canvas
            startY: canvas_h/2,
            line_length: 50,
            line_width: 6,
            line_color: 'black', // You can use the HTML color name instead of the HEX color.
            fill_color: 'black',
            show_start_time: 0 // from the trial start (ms)
        }

        // fication cross for fgurther usage
        var fixationcross = {
            type: 'psychophysics',
            background_color: "white",
            canvas_width: canvas_w,
            canvas_height: canvas_h,
            stimuli: [cross],
            choices: jsPsych.NO_KEYS,
            trial_duration: 1000,
            data:{
                Stimulus_type: "fixationcorss"
            }
                
        };

        // announcement of a new block and time to wait
        var new_block = {
            type: 'html-keyboard-response',
            choices:['space'],
            trial_duration: breakBetweenBlocks,
            stimulus: function(){
                return betweenBlocks+ Math.round((percentages[i]*100)).toString()+ "%" + BonusBetwennBlocks + (Math.round((percentages[i]*100))*0.625/100).toString() + " Pounds" + betweenBlocks2 // this gives feedback about how many trials were correct in the last block
            }
        };

        var new_block_dist = {
            type: 'html-keyboard-response',
            trial_duration: 30000,
            choices:['space'],

            stimulus: function(){
                return betweenBlocks_dist + Math.round((percentages_dist[i]*100)).toString()+ "%" + BonusBetwennBlocks + (Math.round((percentages_dist[i]*100))*0.625/100).toString() + " Pounds"+ betweenBlocks2_dist // this gives feedback about how many trials were correct in the last block
            }
        };

        var BeReady = {
            type: 'html-keyboard-response',
            trial_duration: 2000,
            choices:jsPsych.NO_KEYS,
            stimulus: "<h1> Be ready, the task is starting now! </h1>"
        };

        // announcement of the end of the learning phase and start of the distractor task
        var end_of_learning = {
            type: 'html-keyboard-response',
            choices: ['space'],
            trial_duration: 30000,
            stimulus: function(){
                return DistractorTaskInstructions 
            }
        };

        var end_of_learning_practice = {
            type: 'html-keyboard-response',
            choices: jsPsych.NO_KEYS,
            trial_duration: 5000,
            stimulus: function(){
                return DistractorTaskInstructionsPractice3
            }
        };


        // the end
        var end = {
            type: 'html-keyboard-response',
            choices:['space'],
            stimulus: function(){
                if(total_percentage > 0.0){
                    return betweenBlocks+ "<b>" +Math.round((percentages[ListLengthsOrder.length-1]*100)).toString()+ "%<br></b>" +"Your total score is:" + "<b><br>" +Math.round((total_percentage*0.5 + total_percentage_dist*0.5)*100).toString()+ "%</b>" + last_block// this gives feedback about how many trials were correct in the last block
                }else{
                    return betweenBlocks+ "<b>" +Math.round((percentages[ListLengthsOrder.length-1]*100)).toString()+ "%</b>" +"<p><br>Your total score is:<br></p>" + "<b>" +Math.round((total_percentage*0.5 + total_percentage_dist*0.5)*100).toString()+ "%</b>" 
                }
            },
            data:{
                MTurkID: workerID,
                Stimulus_type: "end_of_experiment",
                TrialType: "experimental_trials",
                save: true,
                assignmentID: assignmentID,
                date: dateString,
                subject_id: subject_id
               
            },
            on_finish: function(data){
                var date2 = new Date()
                var endTime = date2.getTime()
                data.timeMs = date2-date // total time of the task in milliseconds
                data.timeMin = (date2-date)/60000 // total time of the task in Minutes
                data.score = total_percentage
            }
        };


        var feedback = {
            type: 'image-keyboard-response',
            choices: jsPsych.NO_KEYS,
            stimulus_height: fbHeight,
            maintain_aspect_ration: true,
            trial_duration: 1000,
            stimulus: function(){
                var last_trial_correct = jsPsych.data.get().last(1).values()[0].correct;
                if(last_trial_correct == true){
                    return 'Stimuli/right.png';
                } else if (jsPsych.data.get().last(1).values()[0].response == "0"){
                    return "Stimuli/neutral.png";
                } else {
                    return "Stimuli/wrong.png";
                }
            },
        };
        

        // -----------                                    instructions                                                  -----\\


        var betweenBlocks = "<p>Score for the last Block: </p>"

        var BonusBetwennBlocks = "<p> Earned bonus in last block: </p>"

        var betweenBlocks2 = "<p> <br> You get a 1 minute break now. The next block will start automatically once the minute is up.<br> Press spacebar if you already want to continue to the next Block. <br> Please remember to respond as <b>fast</b> as you can! </p>"

        var betweenBlocks_dist = "<p>Score for the Letter task: </p>"

        var betweenBlocks2_dist = "<p> <br> In the next part, we ask you to recall some of the words from the list you learned. <br>"+
            " For this we will present you with one of the words in a pair. Press spacebar as soon as you remember the other word. <br>"+
            " Please remember to respond as <b>fast</b> as you can! <br>"+
            " <b>But it is very important that you only press the spacebar once you remember the word!</b><br>"+
            " After pressing spacebar you will only have 3 seconds to type in the first three letters of the correct word (you can also type the whole word). <br>"+
            " If you cant remember the correct word please just type in <b>0</b>. <br>"+
            " Good Luck! <br> <br>The task will start automatically in a few seconds. Please be ready. <br> You can also press spacebar to start the task now.<br></p>"

        var RecallTaskInstructions = "<p> <br> That was the end of part two. <br>"+
            "<br> In part three we ask you to recall some of the words from the list you learned in part one. <br>"+
            " For this we will present you with one of the words in a pair. Press spacebar as soon as you remember the other word. <br>"+
            " Please remember to respond as <b>fast</b> as you can! <br> After pressing spacebar you will only have 3 seconds to type in the first three letters of the correct word (you can also type the whole word). <br>"+
            " Good Luck! <br> <br>The task will start automatically in a few seconds. Please be ready. </p>"


        var last_block = "<p> <br> Congratulations! You made it through the experiment. <br> Press spacebar to continue to some short final questions."+
            "<br> The page will turn blanck for 10 seconds to ensure that the data gets saved correctly.</p>"

        var DistractorTaskInstructions = "<p> <br> That was the end of the list. <br> Next comes a short perfomance based memory task. <br>" +
            " You will be presented with sequences of 3-7 letters. your task is to type in the sequence in the correct order after each presentation." + 
            " <br> Please try to get as many sequences as possible correct. <br> Good Luck! <br> <br>The task will start automatically in a few seconds. Please be ready. <br> You can also press spacebar to start the task now.<br></p>"

        var DistractorTaskInstructionsPractice = "<p> <br> That was the end of the practice list. <br> Next comes a short perfomance based memory task. <br>" +
            " You will be presented with sequences of 3-7 letters. Your task is to type in the sequence in the correct order after each presentation." + 
            "<br> Press <b> Next</b> to see an example sequence." 

        var DistractorTaskInstructionsPractice2 = "The sequence you saw was <b>pfq</b>, so the correct response would be to type in <b>pfq</b> in the response field that is shown after each sequence. "+ 
            "<br> You have to be relatively quick with typing in your resonse, as you only get a few seconds to do so.<br>" +
            "<br> Lets try this out on a few practice trials.</p>" 

        var DistractorTaskInstructionsPractice3 = " Please try to get as many sequences as possible correct. <br> Good Luck! <br> <br>The task will start automatically in a few seconds. Please be ready. </p>"

        //---------------------------------- distractor task instruction trials ----------------------\\
        var distractorInstructions = {
            type: 'instructions',
            pages: [
                DistractorTaskInstructionsPractice
            ],
            show_clickable_nav: true
        }

        var exampleSequence = ["p", "f", "q"]

        var distractorInstructions2 = {
            type: 'instructions',
            pages: [
                DistractorTaskInstructionsPractice2
            ],
            show_clickable_nav: true
        }

        var end_of_learning_practice = {
            type: 'html-keyboard-response',
            choices: jsPsych.NO_KEYS,
            trial_duration: 5000,
            stimulus: function(){
                return DistractorTaskInstructionsPractice3
            }
        };

        var RecallInstructions = {
            type: 'instructions',
            pages: [
                RecallTaskInstructions
            ],
            show_clickable_nav: true
        }



        // ---------------------------------  some more Instructions -----------------------------------------//

        
        var instructions1 = "<h3>3. The Experiment<br></h3>"
        var instructions2 = "<p>In the next part, we will start with the real experiment<br><br>"+
            "Please try your best to remember the word pairs and be as fast and accurate as possible in the recall task.<br></p>"
        var instructions3 = "<p>As soon as you press <b>Next</b> the experiment will start and your next chance for a break will only be at the end of the first block.<br>"+
            "so now is your chance for a short break.</p>"

        

        var StartOfExperiment = {
            type: 'instructions',
            pages: [
                instructions1,
                instructions2,
                instructions3
            ],
            show_clickable_nav: true
        }

        timeline.push(StartOfExperiment, BeReady)



        // --------------And Finally the real experiment begins!!!! -------------------------------------------------------------------------------------------\\
        // counter, for calculating the final reward
        var total_percentage = 0
        var total_percentage_dist = 0
        var block = 0
        var num = 0
        var percentages = [0, 0, 0, 0]
        var percentages_dist = [0, 0, 0, 0]

        // -------------------------------- Start the real experiment ------------------------------------ //
        // this creates the timline for all the blocks contained in the blockOrder variable 
        for (let i in ListLengthsOrder){
            timeline.push(BeReady)
            block +=1

            // Firts lets create all the trials for the list presentation
            num = 0

            for (let j in WordPairLists[i]){

                num += 1
                
                var wordPairPresentation = {
                    type: 'html-keyboard-response',
                    stimulus: WordPairLists[i][j],
                    choices: "NO_KEYS",
                    trial_duration: presentationTime,
                    stimulus: function(){
                        const myArray = WordPairLists[i][j].split(" ")
                        return "<h1>" + myArray[0] + "<p> - <br> </p>" + myArray[1] + "</h1>"
                    },
                    data: {
                        ListLength: ListLengthsOrder[i],
                        Trial_index: num,
                        Phase: "Learning",
                        correct: "-",
                        ExperimentalPhase: true,
                        Block: block,
                        word1: WordPairLists[i][j].split(" ")[0],
                        word2: WordPairLists[i][j].split(" ")[1],
                        MTurkID: workerID,
                        save: true,
                        assignmentID: assignmentID,
                        date: dateString,
                        subject_id: subject_id
                    }
                };
                var WordResponse1 ={
                    type: "typed-response",
                    prompt: "<h1>" +  WordPairLists[i][j].split(" ")[0] + "</h1>",
                    trial_duration: responseTime, 
                    data: {
                        ListLength: ListLengthsOrder[i],
                        Trial_index: num,
                        Phase: "LearningResponse",
                        Block: block,
                        ExperimentalPhase: true,
                        MTurkID: workerID,
                        save: true,
                        assignmentID: assignmentID,
                        date: dateString,
                        subject_id: subject_id,
                        word1: WordPairLists[i][j].split(" ")[0],
                        word2: WordPairLists[i][j].split(" ")[1],
                        cue:WordPairLists[i][j].split(" ")[0],
                        target:WordPairLists[i][j].split(" ")[1]
                    },
                    on_finish: function(data) {

                        if (data.response.slice(0, 3) == data.target.slice(0,3)){

                            data.correct = true;

                        }else{
                            data.correct = false;
                        }
                    }
                };
                var WordResponse2 ={
                    type: "typed-response",
                    prompt: "<h1>" +  WordPairLists[i][j].split(" ")[1] + "</h1>",
                    trial_duration: responseTime, 
                    data: {
                        ListLength: ListLengthsOrder[i],
                        Trial_index: num,
                        Phase: "LearningResponse",
                        Block: block,
                        ExperimentalPhase: true,
                        MTurkID: workerID,
                        save: true,
                        assignmentID: assignmentID,
                        date: dateString,
                        subject_id: subject_id,
                        word1: WordPairLists[i][j].split(" ")[0],
                        word2: WordPairLists[i][j].split(" ")[1],
                        cue:WordPairLists[i][j].split(" ")[1],
                        target:WordPairLists[i][j].split(" ")[0]
                    },
                    on_finish: function(data) {

                        if (data.response.slice(0, 3) == data.target.slice(0,3)){

                            data.correct = true;

                        }else{
                            data.correct = false;
                        }
                    }
                };

                var feedbackLearning = {
                    type: 'html-keyboard-response',
                    choices: jsPsych.NO_KEYS,
                    stimulus_height: fbHeight,
                    maintain_aspect_ration: true,
                    trial_duration: 2000,
                    stimulus: function(){
                        var last_trial_correct = jsPsych.data.get().last(1).values()[0].correct;
                        if(last_trial_correct == true){
                            return '<h1>' + WordPairLists[i][j].split(" ")[0] + '<p> - <br> </p>' + WordPairLists[i][j].split(" ")[1] + '<br><br><br><br>' + '<img border="0" src="Stimuli/right.png" align="center" style="width:100px;height:100px;">';
                        } else {
                            return "<h1>" + WordPairLists[i][j].split(" ")[0] + "<p> - <br> </p>" + WordPairLists[i][j].split(" ")[1] + "<br><br><br><br>" + '<img border="0" src="Stimuli/wrong.png" align="center" style="width:100px;height:100px;">';
                        }
                    },
                };

                timeline.push(fixationcross, wordPairPresentation, fixationcross, WordResponse1, feedbackLearning, fixationcross, WordResponse2, feedbackLearning)
            }

            timeline.push(end_of_learning);
            num = 0


            // --------------------- distractor task maybe a working memory task with random number recall ---------------------------------\\
            
            // determine lengthOrder in which the letters are presented
            timeline.push(BeReady, fixationcross);

            for (n = 0; n < NDistracorTrials; n++){
                timeline.push(fixationcross);
                num += 1
                for(l = 0; l < AllLetterLengthOrder[i][n]; l++){
                    var letter_presentation = {
                        type: "html-keyboard-response",
                        trial_duration: presentationTime_dist,
                        stimulus:"<h1>" + AllLetterSequences[i][n][l] + "</h1>",
                        choices: "NO_KEYS",
                        
                        data: {SequenceLength: AllLetterLengthOrder[i][n],
                            Trial_index: num,
                            Phase: "LetterPresentation",
                            Block: block,
                            ExperimentalPhase: true,
                            MTurkID: workerID,
                            save: true,
                            assignmentID: assignmentID,
                            date: dateString,
                            subject_id: subject_id,
                            sequence: AllLetterSequences[i][n].join(""),
                            letterSeen:  AllLetterSequences[i][n][l],
                            correct: false
                        }
                    };
                    timeline.push(letter_presentation);
                }
                

                var LetterResponse ={
                    type: "typed-response",
                    prompt: "<h1>" +  "What was the presented sequence?" + "</h1>",
                    trial_duration: responseTime_dist, 
                    data: {
                        SequenceLength: AllLetterLengthOrder[i][n],
                        Trial_index: num,
                        ExperimentalPhase: true,
                        Phase: "LetterRecallResponse",
                        Block: block,
                        MTurkID: workerID,
                        save: true,
                        assignmentID: assignmentID,
                        date: dateString,
                        subject_id: subject_id,
                        sequence: AllLetterSequences[i][n].join("")
                    },
                    on_finish: function(data) {

                        if (data.response ==  data.sequence){

                            data.correct = true;
                            // change the data of the bars
                            jsPsych.data.get().last(2).filter({Phase: 'LetterPresentation'}).values()[0].correct = true
                            

                            percentages_dist[i] = percentages_dist[i] + 1/NDistracorTrials
                            total_percentage_dist = total_percentage_dist + 1/(NDistracorTrials*ListLengths.length)

                        }else{
                            data.correct = false;
                        }
                    }
                };

                

                timeline.push(LetterResponse, feedback);
            }

            var new_block_dist = {
                type: 'html-keyboard-response',
                trial_duration: 30000,
                choices:['space'],

                stimulus: function(){
                    return betweenBlocks_dist + Math.round((percentages_dist[i]*100)).toString()+ "%" +  BonusBetwennBlocks + (Math.round((percentages_dist[i]*100))*0.625/100).toString() + " Pounds" + betweenBlocks2_dist // this gives feedback about how many trials were correct in the last block
                }
            };

            timeline.push(new_block_dist, BeReady, fixationcross)



            // --------------------------------- And finally we have the word query trials ------------------------------------\\
            num = 0
            for (let j in AllCues[i]){
                var CurrentNumberOfQueries = AllCues[i].length
                num += 1
                var CuePresentation = {
                        type: 'html-keyboard-response',
                        stimulus: "<h1>" + AllCues[i][j] + "</h1>"+
                        "<br><br><br> Please press space as soon as you recall the target.",
                        choices:['space'],
                        data: {
                            ListLength: ListLengthsOrder[i],
                            Trial_index: num,
                            Phase: "CuePresentation",
                            correct: false,
                            ExperimentalPhase: true,
                            Block: block,
                            MTurkID: workerID,
                            save: true,
                            assignmentID: assignmentID,
                            date: dateString,
                            subject_id: subject_id,
                            cue:AllCues[i][j],
                            target:AllTargets[i][j],
                            queriedPosition: AllQueriedPositions[i][j]
                        }
                    };
                var WordResponse ={
                    type: "typed-response",
                    prompt: "<h1>" +  AllCues[i][j] + "</h1>",
                    trial_duration: responseTime, 
                    data: {
                        ListLength: ListLengthsOrder[i],
                        Trial_index: num,
                        Phase: "RecallResponse",
                        Block: block,
                        ExperimentalPhase: true,
                        MTurkID: workerID,
                        save: true,
                        assignmentID: assignmentID,
                        date: dateString,
                        subject_id: subject_id,
                        cue:AllCues[i][j],
                        target:AllTargets[i][j],
                        queriedPosition: AllQueriedPositions[i][j]
                    },
                    on_finish: function(data) {

                        if (data.response.slice(0, 3) == AllTargets[i][j].slice(0,3)){

                            data.correct = true;
                            // change the data of the bars
                            jsPsych.data.get().last(2).filter({Phase: 'CuePresentation'}).values()[0].correct = true
                           

                            percentages[i] = percentages[i] + 1/AllCues[i].length
                            total_percentage = total_percentage + (1/AllCues[i].length)/ListLengths.length

                        }else{
                            data.correct = false;
                        }
                    }
                };


                timeline.push(CuePresentation, WordResponse, feedback, fixationcross);
        
            };

            var new_block = {
                type: 'html-keyboard-response',
                choices:['space'],
                trial_duration: breakBetweenBlocks,
                stimulus: function(){
                    return betweenBlocks+ Math.round((percentages[i]*100)).toString()+ "%" + BonusBetwennBlocks + (Math.round((percentages[i]*100)*0.625)/100).toString() + " Pounds" + betweenBlocks2 // this gives feedback about how many trials were correct in the last block
                }
            };
            
            if (i == ListLengthsOrder.length-1){
                timeline.push(end)
            }else{
                timeline.push(new_block)
            }
            
        };



        

        // ----------------------------- save the data ---------------------------------\\

        function saveData1(filedata, finalPercentage){
            var filename = "../data/ID_" + subject_id + "_MTURKID" + workerID + "_PercentageCorrect" + finalPercentage + "_experiment" + ".txt";
            $.post("./results_data.php", {postresult: filedata + "\n", postfile: filename })
        }

        function saveData2(filedata, finalPercentage) {
            var filename = "../data/ID_" + subject_id + "_MTURKID" + workerID + "_PercentageCorrect" + finalPercentage + "_experiment" + ".json";
            $.post("./save_data.php", { postresult: filedata + "\n", postfile: filename })
        }


        function sayHi() {
            window.location.href = nextPage;   
        }


        data_sent = false
        jsPsych.init({
            timeline: timeline,
            show_progress_bar: true,
            on_finish: function() {
                if (!data_sent) {
                    data_sent = true;
                    
                    saveData1(jsPsych.data.get().filter({save: true}).json().toString(), Math.round((total_percentage*0.5 + total_percentage_dist*0.5)*100).toString());
                    saveData2(jsPsych.data.get().filter({save: true}).json(), Math.round((total_percentage*0.5 + total_percentage_dist*0.5)*100).toString())
                    //saveDataToDb()
                    console.log("end")

                    setTimeout(sayHi, 10000); // 2 sekunden
                    

                    //window.location.href = nextPage; //send them to the next page



                };

            },

        })

        var all_data = jsPsych.data.get("rt");
    </script>


</html>